global:
  env:
    - APP_ENV: production
    - DB_HOST: 'MAP:DATABASE1_HOST'
    - DB_DATABASE: 'MAP:DATABASE1_NAME'
    - DB_USERNAME: 'MAP:DATABASE1_USER'
    - DB_PASSWORD: 'MAP:DATABASE1_PASS'
    - SESSION_DRIVER: redis


build:
  before_exec:
    - 'rm -rf puphet'
    - 'rm Vagrantfile'
    - 'rm -rf public/img'
    - 'rm -rf html'
#    - 'rm -rf vendor'
  exec:
    - 'COMPOSER_DISCARD_CHANGES=true'
    - 'composer clear-cache'
    - 'composer install --no-interaction --prefer-dist --no-dev -vvvv'
  after_exec:
    - 'composer dump-autoload --optimize'
    - 'php vendor/bin/phinx migrate -c config/autoload/phinx.local.php -e prod'
    - 'php vendor/bin/phinx seed:run -c config/phinx.php -e dev --seed GameSeed'
  lib_dirs:
    - vendor
  reuse_libs: true

web1:
  type: php
  version: 5.6
  php_extensions:
    - json
    - mbstring
    - mcrypt
    - pdo_mysql
    - redis
    - curl
    - zip
  httpd_document_root: public
  php_session_save_handler: redis
  php_session_save_path: "tcp://${CACHE1_HOST}:${CACHE1_PORT}"
  network_dirs:
    - tmp/
  nonpersistent_writable_dirs:
    - data/cache
    - data/logs
  after_deploy:
    - 'php vendor/bin/phinx migrate -c config/phinx.php -e prod'
    - 'php vendor/bin/phinx seed:run -c config/phinx.php -e prod --seed=GameSeed'
    - 'php vendor/bin/phinx seed:run -c config/phinx.php -e prod --seed=NamesSeeds'
    - 'php vendor/bin/phinx seed:run -c config/phinx.php -e prod --seed=SuperSeed'
  log_watch:
    - cmwn[php]: data/logs/app.log

worker1:
   exec: 'php public/index.php worker --queue=default'
   php_extensions:
    - json
    - mbstring
    - mcrypt
    - pdo_mysql
    - redis
    - curl
    - zip
   network_dirs:
    - tmp/
   nonpersistent_writable_dirs:
    - data/cache
    - data/logs
   log_watch:
     - cmwn[php]: data/logs/app.log

database1:
  type: mysql
  version: 5.6

cache1:
  type: redis

storage1:
  type: nfs
