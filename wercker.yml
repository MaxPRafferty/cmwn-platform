box:
  id: cmwn/platform-api
  username: $DOCKER_USER
  password: $DOCKER_PASS
  tag: latest
build:
  services:
    - id: mysql:5.5
      env:
        MYSQL_ROOT_PASSWORD: cmwn_pass123
        MYSQL_DATABASE: cmwn_test
        MYSQL_USER: cmwn_user
        MYSQL_PASSWORD: cmwn_pass
  steps:
    - script:
      name: install dependencies
      code: |-
        export COMPOSER_CACHE_DIR=$WERCKER_CACHE_DIR/composer
        export COMPOSER_BIN_DIR=$WERCKER_CACHE_DIR/bin
        composer install --no-interaction --no-dev --prefer-dist
    - script:
      name: Setup test DB
      code: phinx migrate -c $PWD/config/phinx.php -e test
    - script:
      name: PHPCS Check
      code: phpcs --standard=PSR2 -p --no-colors module
    - script:
      name: PHPMD
      code: phpmd module text codesize,design,controversial --suffixes php --exclude "*Test*"
    - script:
      name: PHPUNIT
      code: |-
        export USE_ZEND_ALLOC=0
        phpunit -c $PWD/test/phpunit.xml --stop-on-error --stop-on-failure --colors=never
package:
  steps:
    - script:
      name: Creating package
      code: ls -al