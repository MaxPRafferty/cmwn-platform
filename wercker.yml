box:
  id: cmwn/platform-api:0.1
  username: $DOCKER_USER
  password: $DOCKER_PASS
  tag: latest

build:
  services:
    - id: mysql:5.5
      env:
        MYSQL_ROOT_PASSWORD: cmwn_pass123
        MYSQL_DATABASE: cmwn_test
        MYSQL_USER: cmwn_user
        MYSQL_PASSWORD: cmwn_pass
  steps:
    - script:
      name: install dependencies
      code: composer install --no-interaction
    - script:
      name: Setup test DB
      code: |-
        sleep 5
        phinx migrate -c $PWD/config/phinx.php -e test
    - script:
      name: PHPCS Check
      code: phpcs --standard=PSR2 -p --no-colors module
    - script:
      name: PHPMD
      code: phpmd module text codesize,design,controversial --suffixes php --exclude "*Test*"
    - script:
      name: PHPUNIT
      code: |-
        export USE_ZEND_ALLOC=0
        $PWD/vendor/bin/phpunit -c $PWD/test/phpunit.xml --stop-on-error --stop-on-failure --colors=never
  after-steps:
    - slack-notifier:
      url: $SLACK_URL

deploy:
  steps:
    - script:
      name: Setting VERSION, PACKAGE, DRAFT and the artifact directory
      code: |-
        export VERSION="$(cat composer.json | php -r 'echo json_decode(file_get_contents("php://stdin"))->version;')"
        export PACKAGE="$(echo "platform-api-$VERSION-$(git rev-parse --short HEAD)")"
        export DRAFT="$(if [ "$WERCKER_GIT_BRANCH" != "master" ]; then echo -n "true" ; else echo -n "false" ; fi)"
        echo "Creating package $PACKAGE for verson: $VERSION"
        if [ $DRAFT = 'true' ]; then echo "Its a draft"; else echo "This is not a draft"; fi
        mkdir -p data/build/artifact
    - script:
      name: Running Zend-Tool
      code: /usr/sbin/zfdeploy.php build "data/build/artifact/platform-api-$VERSION.zip" --composer=off --vendor
    - s3sync:
      name: Uploading package to Amazon S3
      key-id: $AWS_KEY
      key-secret: $AWS_SECRET
      bucket-url: $AWS_BUCKET_URL
      source-dir: data/build/artifact/
    - github-create-release:
      name: Creating release on github
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      draft: $DRAFT
    - github-upload-asset:
      name: Uploading build to github
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      file: data/build/artifact/platform-api-$VERSION.zip
      filename: $PACKAGE.zip
